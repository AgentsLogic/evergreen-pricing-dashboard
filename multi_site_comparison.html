<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitive Pricing Intelligence - Market Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .price-highlight {
            background: linear-gradient(45deg, #10b981, #059669);
        }
        .savings-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Competitive Pricing Intelligence</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        ‚Üê Back to Dashboard
                    </a>
                    <button @click="refreshData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                        üîÑ Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-data="multiSiteComparison()">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">üìä</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-500">Products Compared</div>
                        <div class="text-2xl font-semibold text-gray-900" x-text="stats.total_products"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">üí∞</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-500">Avg Price Range</div>
                        <div class="text-2xl font-semibold text-gray-900" x-text="stats.avg_price_range ? '$' + stats.avg_price_range.toFixed(0) : 'N/A'"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">üèÜ</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-500">Market Spread</div>
                        <div class="text-2xl font-semibold text-gray-900" x-text="stats.max_savings ? '$' + stats.max_savings.toFixed(0) : 'N/A'"></div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-orange-500 rounded-md flex items-center justify-center">
                            <span class="text-white font-bold text-sm">üè¢</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-medium text-gray-500">Sites Compared</div>
                        <div class="text-2xl font-semibold text-gray-900" x-text="stats.total_sites"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Products</label>
                    <input type="text" x-model="filters.search" placeholder="Search by brand, model..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Product Type</label>
                    <select x-model="filters.product_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">All Types</option>
                        <option value="Laptop">Laptops</option>
                        <option value="Desktop">Desktops</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Min Price Range</label>
                    <select x-model="filters.min_range" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="0">Any Range</option>
                        <option value="50">$50+</option>
                        <option value="100">$100+</option>
                        <option value="200">$200+</option>
                        <option value="500">$500+</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                    <select x-model="filters.sort_by" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="price_range">Price Range (High to Low)</option>
                        <option value="lowest_price">Lowest Price</option>
                        <option value="brand">Brand</option>
                        <option value="model">Model</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div x-show="loading" class="bg-white rounded-lg shadow p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Loading competitive market analysis...</p>
        </div>

        <!-- Error State -->
        <div x-show="error" class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
            <div class="text-red-600 text-lg font-medium" x-text="error"></div>
            <button @click="refreshData()" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                Try Again
            </button>
        </div>

        <!-- Products List -->
        <div x-show="!loading && !error && filteredProducts.length === 0" class="bg-white rounded-lg shadow p-8 text-center">
            <div class="text-gray-500 text-lg">No products found matching your criteria.</div>
            <button @click="clearFilters()" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium">
                Clear Filters
            </button>
        </div>

        <!-- Products Grid -->
        <div x-show="!loading && !error && filteredProducts.length > 0" class="space-y-6">
            <template x-for="(product, index) in paginatedProducts" :key="index">
                <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                    <!-- Product Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 text-white">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold" x-text="product.brand + ' ' + product.model"></h3>
                                <p class="text-blue-100 mt-1" x-text="product.product_type"></p>
                                <p class="text-sm text-blue-100 mt-2 opacity-90" x-text="product.title"></p>
                            </div>
                            <div class="text-right">
                                <div class="savings-badge text-white px-3 py-1 rounded-full text-sm font-medium" x-show="product.price_range">
                                    <span x-text="'Market spread: $' + product.price_range.toFixed(0)"></span>
                                </div>
                                <div class="text-sm text-blue-100 mt-1">
                                    <span x-text="product.sites.length + ' sites'"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Price Comparison Table -->
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead>
                                    <tr class="border-b border-gray-200">
                                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Site</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Price</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Availability</th>
                                        <th class="text-left py-3 px-4 font-semibold text-gray-900">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(site, siteIndex) in product.sites" :key="siteIndex">
                                        <tr class="border-b border-gray-100" :class="siteIndex === 0 ? 'bg-green-50' : ''">
                                            <td class="py-4 px-4">
                                                <div class="flex items-center">
                                                    <div class="font-medium text-gray-900" x-text="site.competitor"></div>
                                                    <div x-show="siteIndex === 0" class="ml-2 price-highlight text-white px-2 py-1 rounded text-xs font-medium">
                                                        Best Price
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="py-4 px-4">
                                                <div class="text-lg font-bold" x-text="site.price != null ? '$' + Math.round(site.price) : 'N/A'"></div>
                                                <div x-show="siteIndex > 0 && product.lowest_price" class="text-sm text-gray-500">
                                                    <span x-text="'$' + Math.round(site.price - product.lowest_price) + ' more'"></span>
                                                </div>
                                            </td>
                                            <td class="py-4 px-4">
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                                      :class="site.availability && site.availability.toLowerCase().includes('available') ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'"
                                                      x-text="site.availability || 'Available'">
                                                </span>
                                            </td>
                                            <td class="py-4 px-4">
                                                <a :href="site.url" target="_blank" class="inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                                    View ‚Üí
                                                </a>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <!-- Price Summary -->
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-gray-200">
                            <div class="text-center">
                                <div class="text-sm text-gray-500">Lowest Price</div>
                                <div class="text-xl font-bold text-green-600" x-text="product.lowest_price != null ? '$' + Math.round(product.lowest_price) : 'N/A'"></div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-500">Average Price</div>
                                <div class="text-xl font-bold text-blue-600" x-text="product.avg_price != null ? '$' + Math.round(product.avg_price) : 'N/A'"></div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-500">Highest Price</div>
                                <div class="text-xl font-bold text-red-600" x-text="product.highest_price != null ? '$' + Math.round(product.highest_price) : 'N/A'"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>

        <!-- Pagination -->
        <div x-show="!loading && !error && totalPages > 1" class="mt-8 flex justify-center">
            <div class="flex space-x-2">
                <button @click="currentPage = Math.max(1, currentPage - 1)"
                        :disabled="currentPage === 1"
                        class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        :class="currentPage === 1 ? 'text-gray-400' : 'text-gray-700 hover:bg-gray-50'">
                    ‚Üê Previous
                </button>

                <div class="flex space-x-1">
                    <template x-for="page in visiblePages" :key="page">
                        <button @click="currentPage = page"
                                class="px-3 py-2 border rounded-md text-sm font-medium transition-colors"
                                :class="currentPage === page ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-300 text-gray-700 hover:bg-gray-50'">
                            <span x-text="page"></span>
                        </button>
                    </template>
                </div>

                <button @click="currentPage = Math.min(totalPages, currentPage + 1)"
                        :disabled="currentPage === totalPages"
                        class="px-3 py-2 border border-gray-300 rounded-md text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        :class="currentPage === totalPages ? 'text-gray-400' : 'text-gray-700 hover:bg-gray-50'">
                    Next ‚Üí
                </button>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-12 text-center text-gray-500 text-sm">
            <p>üí° Tip: Products are sorted by market spread. The green "Best Price" badge shows the lowest competitor price for pricing strategy.</p>
        </div>
    </div>

    <script>
        function multiSiteComparison() {
            return {
                products: [],
                filteredProducts: [],
                loading: true,
                error: null,
                currentPage: 1,
                itemsPerPage: 10,
                stats: {
                    total_products: 0,
                    avg_price_range: 0,
                    max_savings: 0,
                    total_sites: 0
                },
                filters: {
                    search: '',
                    product_type: '',
                    min_range: 0,
                    sort_by: 'price_range'
                },

                async init() {
                    await this.refreshData();
                },

                async refreshData() {
                    this.loading = true;
                    this.error = null;

                    try {
                        const response = await fetch('/api/multi-site');
                        const data = await response.json();

                        if (response.ok) {
                            this.products = data.products;
                            this.calculateStats();
                            this.applyFilters();
                        } else {
                            this.error = data.error || 'Failed to load data';
                        }
                    } catch (err) {
                        this.error = 'Failed to connect to server';
                        console.error('Error loading data:', err);
                    } finally {
                        this.loading = false;
                    }
                },

                calculateStats() {
                    if (this.products.length === 0) {
                        this.stats = {
                            total_products: 0,
                            avg_price_range: 0,
                            max_savings: 0,
                            total_sites: 0
                        };
                        return;
                    }

                    const priceRanges = this.products
                        .map(p => p.price_range)
                        .filter(range => range !== null && range !== undefined);

                    const allSites = new Set();
                    this.products.forEach(product => {
                        product.sites.forEach(site => allSites.add(site.competitor));
                    });

                    this.stats = {
                        total_products: this.products.length,
                        avg_price_range: priceRanges.length > 0 ? priceRanges.reduce((a, b) => a + b, 0) / priceRanges.length : 0,
                        max_savings: Math.max(...priceRanges, 0),
                        total_sites: allSites.size
                    };
                },

                applyFilters() {
                    let filtered = [...this.products];

                    // Search filter
                    if (this.filters.search) {
                        const searchTerm = this.filters.search.toLowerCase();
                        filtered = filtered.filter(product =>
                            product.brand.toLowerCase().includes(searchTerm) ||
                            product.model.toLowerCase().includes(searchTerm) ||
                            product.title.toLowerCase().includes(searchTerm)
                        );
                    }

                    // Product type filter
                    if (this.filters.product_type) {
                        filtered = filtered.filter(product =>
                            product.product_type === this.filters.product_type
                        );
                    }

                    // Minimum price range filter
                    if (this.filters.min_range > 0) {
                        filtered = filtered.filter(product =>
                            product.price_range >= this.filters.min_range
                        );
                    }

                    // Sort
                    switch (this.filters.sort_by) {
                        case 'lowest_price':
                            filtered.sort((a, b) => (a.lowest_price || 0) - (b.lowest_price || 0));
                            break;
                        case 'brand':
                            filtered.sort((a, b) => a.brand.localeCompare(b.brand));
                            break;
                        case 'model':
                            filtered.sort((a, b) => a.model.localeCompare(b.model));
                            break;
                        case 'price_range':
                        default:
                            filtered.sort((a, b) => (b.price_range || 0) - (a.price_range || 0));
                            break;
                    }

                    this.filteredProducts = filtered;
                    this.currentPage = 1;
                },

                clearFilters() {
                    this.filters = {
                        search: '',
                        product_type: '',
                        min_range: 0,
                        sort_by: 'price_range'
                    };
                    this.applyFilters();
                },

                get paginatedProducts() {
                    const start = (this.currentPage - 1) * this.itemsPerPage;
                    const end = start + this.itemsPerPage;
                    return this.filteredProducts.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.filteredProducts.length / this.itemsPerPage);
                },

                get visiblePages() {
                    const pages = [];
                    const total = this.totalPages;
                    const current = this.currentPage;

                    if (total <= 7) {
                        for (let i = 1; i <= total; i++) {
                            pages.push(i);
                        }
                    } else {
                        if (current <= 4) {
                            pages.push(1, 2, 3, 4, 5, 6, 7);
                        } else if (current >= total - 3) {
                            pages.push(total - 6, total - 5, total - 4, total - 3, total - 2, total - 1, total);
                        } else {
                            pages.push(current - 3, current - 2, current - 1, current, current + 1, current + 2, current + 3);
                        }
                    }

                    return pages;
                }
            }
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            if (!document.querySelector('[x-data*="multiSiteComparison"]')?.__x) return;
            // Only refresh if page is visible
            if (document.visibilityState === 'visible') {
                // Optional: Add a subtle notification before refresh
                console.log('Auto-refreshing multi-site comparison data...');
                // Uncomment the next line if you want auto-refresh
                // Alpine.raw(document.querySelector('[x-data*="multiSiteComparison"]')).refreshData();
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>
